{% extends 'base.html' %}
{% block content %}

<div class="row">
	<div class="col-md-10 col-md-offset-1">
		<div class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">{{ title }}</h3>
			
			</div>
			
            <div class="panel-body">

			<!-- SOLICITUD DE ANALISIS -->
			<div class="col-sm-12">
		        <div class="panel panel-default">
		            <div class="panel-heading">
		                <h3 class="panel-title">Solicitud de Analisis</h3>
		            </div>
		            <div class="panel-body">
		            	<div class="col-sm-6">
							<dl class="dl-horizontal">
								<dt>Veterinario</dt>
								<dd>{{ instance.solicitud.veterinario }}</dd>
								<dt>Fecha</dt>
								<dd>{{ instance.solicitud.fecha }}</dd>
								<dt>RENSPA</dt>
								<dd>{{ instance.solicitud.establecimiento.RENSPA }}</dd>
								<dt>Establecimiento</dt>
								<dd>{{ instance.solicitud.establecimiento }}</dd>
								<dt>N. de Protocolo</dt>
								<dd>{{ instance.protocolo.numero }}</dd>
		            		</dl>
		            	</div>
		            	<div class="col-sm-6">
							<dl class="dl-horizontal">
								<dt>Diagnostico</dt>
								<dd>{{ instance.diagnostico }}</dd>
								<dt>Muestra</dt>
								<dd>{{ instance.diagnostico.muestra }}</dd>
								<dt>Tecnica</dt>
								<dd>{{ instance.diagnostico.tecnica }}</dd>
								<dt>Observaciones</dt>
							<dd>{{ instance.solicitud.obs }}</dd>
								
		            		</dl>
		            	</div>
		            </div>
		        </div>
			</div>

<!-- panel para grupos con visualizacion de tablas -->
<form class="form-horizontal" method="POST" id='formupdateDA' action="">{% csrf_token %} 
			{% for key, value in grupos.items %}
				{% for v in value %}
				<div class="col-sm-12">
			        <div class="panel panel-default">
			        	<div class="panel-heading">
			                <h3 class="panel-title">
			                	<!-- Titulo del grupo: -->
			                	 {{ key }}</h3>
			            </div>
			            <div class="panel-body" style="overflow-x:scroll">
							<table class="table table-striped table-hover table-condensed table-responsive" align="center">
								<thead class="thead-default">
									<tr>
										<th>Identificacion</th>
										{% for p in v %}
											<th>{{ p.descripcion|truncatechars:11 }}</th>
											<th></th>
										{% endfor %}
									</tr>
								</thead>
								<tbody>
								{% for i in object_list_ind %}
									<tr>
										<td>{{ i.individuoPadre.identificacion }}</td>
										{% for p in v  %}
										<td class="col-sm-2">
										{% for da, valor in da_list.items %}
											{% if i.individuoPadre.identificacion == da.individuoPadre.identificacion and p == da.parametros %}

											<div class="posicionTabla">
												{% if p.tipo_de_dato == 'S' %}
												<input type="hidden" id="posDA" name="dapos" value="{{da.id}}" />
												<input type="text" maxlength="10" class="form-control" id="valorDA" name="_" value="{{ valor }}">{% endif %}
												{% if p.tipo_de_dato == 'I' %}
												<input type="hidden" id="posDA" name="dapos" value="{{da.id}}" />
												<input type="number" maxlength="10" class="form-control" id="valorDA" name="_" value="{{ valor }}">{% endif %}
												{% if p.tipo_de_dato == 'F' %}
												<input type="hidden" id="posDA" name="dapos" value="{{da.id}}" />
												<input type="number" maxlength="10" step="0.01" class="form-control" id="valorDA" name="_" value="{{ valor }}">{% endif %}
												{% if p.tipo_de_dato == 'B' %}
												{% if valor == 'Positivo' %}
													<select id="valorDA" class="form-control selectpicker" >
										              <option value="Negativo">Negativo</option>
										              <option selected="selected" value="Positivo">Positivo</option>
										            </select>
										        <input type="hidden" name="dapos" id="posDA" value="{{da.id}}" />
										        {% else %}
										            <select id="valorDA" class="form-control selectpicker" >
										              <option selected="selected"value="Negativo">Negativo</option>
										              <option  value="Positivo">Positivo</option>
										            </select>
										        <input type="hidden" name="dapos" id="posDA" value="{{da.id}}" />
										            {% endif%}
											    {% endif %}	
											</div>
											{% endif %}
										{% endfor %}
										</td>
										<td>{{ p.unidadmedida}}</td>
										{% endfor %}
									</tr>
								{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
				{% endfor %}
			{% endfor %}

<!-- panel para grupos con visualizacion items -->
			{% for objg in grupoi%}
			<div class="col-sm-12">
		        <div class="panel panel-default">
		        	<div class="panel-heading">
		                <h3 class="panel-title">{{ objg.grupo }} </h3>
		            </div>		            
		            <div class="panel-body">
		            	{% for da in da_list %}
		            		{% if objg.grupo == da.parametros.grupo and da.individuoPadre == indi.individuoPadre %}	
			            	<dl class="dl-horizontal">
			            		<dt>{{ da.parametros.descripcion }}</dt>
			            		<div class="posicionItem">
						        <dd><input type="text" maxlength="10" class="form-control" id="valorDA" name="_" value="{{ da.valor }}">{{ da.parametros.unidadmedida}}</dd>
				            		{% for i in object_list_ind %}
					            	<input type="hidden" name="dapos" class="posDA" value="{{da.id}}" />
				            		{% endfor %}
				            		</dd>
			            		</div>
			            	</dl>
			            		
							{% endif %}
		            	{% endfor %}
					</div>
		        </div>
			</div>
			{% endfor %}

			<div class="col-sm-12">
            	<textarea row="3" class="form-control" id="piepagina" name="piepagina" value="">Observaciones realizadas durante el an√°lisis de las muestras:</textarea>
			</div>
    		</div><!-- final panel-body -->
    		<div class="panel-footer">
                    <div class="row">
                    	<div class="col-sm-6" align="left">
    			<a href="{% url 'bsuser:v_detalleanalisispadre' id=instance.id %}"><span class="glyphicon glyphicon-chevron-left"></span> Volver</a>
                    	</div>
                        <div class="col-sm-6" align="right">
                            
    			<button id="testda"> TESTEO </button>
    		<a href="#" class="btn btn-default btn-sm" role="button">Cargar Resultados</a>
                            
                        </div>
                    </div></form>
                </div> <!--fin panel footer-->
    
		</div>
	</div>
</div>



{% endblock %}


{% block javascript %} 
<script type="text/javascript">
    controlGPS();

  	function controlGPS(){
      if( localStorage.getItem( "posicion" ) ){
        	localStorage.setItem( "posicion", 0);
      }
      else{
			localStorage.setItem( "posicion", 0);
      }
    }

$('#testda').click(function(e){
		e.preventDefault();
		let posicionDA = []; 
		let valorDA = [];
		$(".posicionTabla").each(function(){
			var posDA = $(this).find('#posDA').val();
			var valDA = $(this).find('#valorDA').val();
			posicionDA.push(posDA);
			valorDA.push(valDA);
			//console.log('Posicion: ' + posDA + ' Valor: ' + valDA) 
		});
		posicionDA = JSON.stringify( posicionDA )
		valorDA = JSON.stringify( valorDA )
		
		$.ajax({
				type: 'POST',
				url: '/updateDA/',
				data:{
					posicionDA: posicionDA,
					valorDA: valorDA,
					csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
				},
				statusCode: {
					404: function () {
					},
					500: function(){
						alert('ERROR')
					},
					200: function () {
						
					}
				}
			});


		$(".posicionItem").each(function(){
			var valorDA2 = $(this).find('#valorDA').val();
			let posicionDA2 = [];
			$(this).find('.posDA').each(function(){
				var posDA = $(this).val();
				posicionDA2.push(posDA);
			})
			posicionDA2 = JSON.stringify( posicionDA2 )

			$.ajax({
				type: 'POST',
				url: '/updateDA2/',
				data:{
					posicionDA2: posicionDA2,
					valorDA2: valorDA2,
					csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
				},
				statusCode: {
					404: function () {
					},
					500: function(){
						alert('ERROR')
					},
					200: function () {
						
					}
				}
			});
			
		});
});
</script> 
{% endblock %}
